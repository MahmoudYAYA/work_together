{% extends 'base.html.twig' %}

{% block title %}Mes Commandes - WorkTogether{% endblock %}

{% block body %}
<div class="container-fluid mt-5">
    <!-- ========== EN-TÊTE DE LA PAGE ========== -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-5 fw-bold">
                <i class="bi bi-receipt-cutoff"></i> Mes Commandes
            </h1>
            <p class="text-muted">Gérez et suivez vos commandes en temps réel</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ path('commande_new') }}" class="btn btn-primary btn-lg">
                <i class="bi bi-plus-circle"></i> Nouvelle commande
            </a>
        </div>
    </div>

    <!-- ========== STATISTIQUES RAPIDES ========== -->
    <div class="row mb-4">
        <!-- Carte 1 : Total commandes -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">Total commandes</p>
                            <h3 class="fw-bold">{{ commandes|length }}</h3>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-receipt text-primary fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Carte 2 : Commandes payées -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">Commandes payées</p>
                            <h3 class="fw-bold text-success">
                                {{ commandes|filter(c => c.statut == 'Payée')|length }}
                            </h3>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-check-circle text-success fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Carte 3 : En attente de paiement -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">En attente de paiement</p>
                            <h3 class="fw-bold text-warning">
                                {{ commandes|filter(c => c.statut == 'En attente paiement')|length }}
                            </h3>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-clock-history text-warning fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Carte 4 : Montant total investi -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1">Total investi (TTC)</p>
                            <h3 class="fw-bold text-info">
                                {{ (commandes|reduce((carry, c) => carry + c.montantTotal, 0))|number_format(2, ',', ' ') }} €
                            </h3>
                        </div>
                        <div class="bg-info bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-cash-coin text-info fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== FILTRES ET RECHERCHE ========== -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="GET" class="row g-3" id="filterForm">
                        <div class="col-md-4">
                            <label for="searchInput" class="form-label">
                                <i class="bi bi-search"></i> Rechercher
                            </label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="searchInput" 
                                name="search"
                                placeholder="Numéro de commande ou facture..."
                                value="{{ app.request.query.get('search') }}"
                            >
                        </div>

                        <div class="col-md-3">
                            <label for="statusFilter" class="form-label">
                                <i class="bi bi-funnel"></i> Statut
                            </label>
                            <select class="form-select" id="statusFilter" name="statut">
                                <option value="">-- Tous les statuts --</option>
                                <option value="En attente paiement" {% if app.request.query.get('statut') == 'En attente paiement' %}selected{% endif %}>
                                    En attente de paiement
                                </option>
                                <option value="Payée" {% if app.request.query.get('statut') == 'Payée' %}selected{% endif %}>
                                    Payée
                                </option>
                                <option value="Livrée" {% if app.request.query.get('statut') == 'Livrée' %}selected{% endif %}>
                                    Livrée
                                </option>
                                <option value="Annulée" {% if app.request.query.get('statut') == 'Annulée' %}selected{% endif %}>
                                    Annulée
                                </option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="dateFilter" class="form-label">
                                <i class="bi bi-calendar3"></i> Date
                            </label>
                            <input 
                                type="date" 
                                class="form-control" 
                                id="dateFilter" 
                                name="date"
                                value="{{ app.request.query.get('date') }}"
                            >
                        </div>

                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-outline-primary w-100">
                                <i class="bi bi-arrow-clockwise"></i> Filtrer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== TABLEAU DES COMMANDES ========== -->
    <div class="row">
        <div class="col-md-12">
            {% if commandes|length > 0 %}
                <div class="card border-0 shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">
                                        <i class="bi bi-receipt"></i> Numéro
                                    </th>
                                    <th scope="col">
                                        <i class="bi bi-calendar-event"></i> Date
                                    </th>
                                    <th scope="col">
                                        <i class="bi bi-box"></i> Offre
                                    </th>
                                    <th scope="col">
                                        <i class="bi bi-cash-coin"></i> Montant HT
                                    </th>
                                    <th scope="col">
                                        <i class="bi bi-percent"></i> TVA
                                    </th>
                                    <th scope="col">
                                        <i class="bi bi-cash"></i> Total TTC
                                    </th>
                                    <th scope="col">
                                        <i class="bi bi-info-circle"></i> Statut
                                    </th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for commande in commandes %}
                                <tr class="align-middle">
                                    <!-- Numéro de commande -->
                                    <td>
                                        <strong class="text-primary">
                                            {{ commande.numeroCommande }}
                                        </strong>
                                        {% if commande.numeroFacture %}
                                            <br>
                                            <small class="text-muted">
                                                <i class="bi bi-file-earmark-text"></i>
                                                {{ commande.numeroFacture }}
                                            </small>
                                        {% endif %}
                                    </td>

                                    <!-- Date de commande -->
                                    <td>
                                        <span class="text-muted">
                                            {{ commande.dateCommande|date('d/m/Y') }}
                                        </span>
                                        <br>
                                        <small class="text-muted">
                                            {{ commande.dateCommande|date('H:i') }}
                                        </small>
                                    </td>

                                    <!-- Offre -->
                                    <td>
                                        <span class="badge bg-info text-dark">
                                            {{ commande.offre.nom }}
                                        </span>
                                        <br>
                                        <small class="text-muted">
                                            {{ commande.offre.nombreUnites }} unités
                                        </small>
                                    </td>

                                    <!-- Montant HT -->
                                    <td>
                                        <strong>
                                            {{ commande.montantTotal|number_format(2, ',', ' ') }} €
                                        </strong>
                                    </td>

                                    <!-- TVA -->
                                    <td>
                                        <span class="text-warning">
                                            +{{ commande.montantTVA|number_format(2, ',', ' ') }} €
                                        </span>
                                        <br>
                                        <small class="text-muted">
                                            ({{ ((commande.montantTVA / commande.montantTotal) * 100)|round(1) }}%)
                                        </small>
                                    </td>

                                    <!-- Montant TTC -->
                                    <td>
                                        <strong class="text-success fs-5">
                                            {{ (commande.montantTotal + commande.montantTVA)|number_format(2, ',', ' ') }} €
                                        </strong>
                                    </td>

                                    <!-- Statut -->
                                    <td>
                                        {% set badgeClass = {
                                            'En attente paiement': 'bg-warning text-dark',
                                            'Payée': 'bg-success',
                                            'Livrée': 'bg-info',
                                            'Annulée': 'bg-danger'
                                        } %}
                                        {% set icon = {
                                            'En attente paiement': 'clock-history',
                                            'Payée': 'check-circle',
                                            'Livrée': 'box-seam',
                                            'Annulée': 'x-circle'
                                        } %}
                                        
                                        <span class="badge {{ badgeClass[commande.statut] }}">
                                            <i class="bi bi-{{ icon[commande.statut] }}"></i>
                                            {{ commande.statut }}
                                        </span>
                                    </td>

                                    <!-- Actions -->
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a 
                                                href="{{ path('commande_show', {'id': commande.id}) }}" 
                                                class="btn btn-sm btn-outline-primary"
                                                title="Voir détails"
                                            >
                                                <i class="bi bi-eye"></i> Voir
                                            </a>
                                            
                                            {% if commande.statut == 'En attente paiement' %}
                                                <a 
                                                    href="{{ path('commande_paied', {'id': commande.id}) }}" 
                                                    class="btn btn-sm btn-outline-success"
                                                    title="Payer maintenant"
                                                >
                                                    <i class="bi bi-credit-card"></i> Payer
                                                </a>
                                            {% endif %}

                                            {% if commande.peutEtreAnnulee() %}
                                                <button 
                                                    class="btn btn-sm btn-outline-danger"
                                                    onclick="confirmAnnulation({{ commande.id }}, '{{ commande.numeroCommande }}')"
                                                    title="Annuler"
                                                >
                                                    <i class="bi bi-trash"></i> Annuler
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% else %}
                <!-- Message quand aucune commande -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted mb-3" style="display: block;"></i>
                        <h5 class="text-muted">Aucune commande trouvée</h5>
                        <p class="text-muted mb-3">
                            Vous n'avez pas encore de commande. Créez-en une maintenant !
                        </p>
                        <a href="{{ path('commande_new') }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Créer une commande
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

   {# DÉTAILS DES SERVICES  #}
    <div class="row mt-5">
        <div class="col-md-12">
            <h5 class="fw-bold mb-3">
                <i class="bi bi-info-circle"></i> Périodes de service actives
            </h5>
            <div class="row">
                {% set hasActiveServices = false %}
                {% for commande in commandes %}
                    {% if commande.statut == 'Livrée' and commande.dateFinService >= 'now'|date %}
                        {% set hasActiveServices = true %}
                        <div class="col-md-4 mb-3">
                            <div class="card border-left-success border-0 shadow-sm">
                                <div class="card-body">
                                    <h6 class="card-title fw-bold text-success">
                                        {{ commande.numeroCommande }}
                                    </h6>
                                    <p class="card-text small mb-2">
                                        <strong>Offre :</strong> {{ commande.offre.nom }}
                                    </p>
                                    <p class="card-text small mb-2">
                                        <strong>Du :</strong> {{ commande.dateDebutService|date('d/m/Y') }}<br>
                                        <strong>Au :</strong> {{ commande.dateFinService|date('d/m/Y') }}
                                    </p>
                                    <p class="card-text small text-muted">
                                        Durée : {{ commande.calculerDureeService() }} jours
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}

                {% if not hasActiveServices %}
                    <div class="col-md-12">
                        <p class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Aucun service actif en ce moment
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# MODAL CONFIRMATION ANNULATION  #}
<div class="modal fade" id="confirmAnnulationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Confirmer l'annulation
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">
                    Êtes-vous sûr de vouloir annuler la commande <strong id="commandeNumber"></strong> ?
                </p>
                <p class="text-muted small mt-2">
                    Cette action est <strong>irréversible</strong>.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Non, conserver
                </button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger">
                        Oui, annuler la commande
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>


<style>
    .border-left-success {
        border-left: 4px solid #198754 !important;
    }

    .card:hover {
        transition: box-shadow 0.3s ease;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }

    .btn-group .btn {
        padding: 0.35rem 0.5rem;
        font-size: 0.875rem;
    }
</style>


<script>
    function confirmAnnulation(commandeId, commandeNumber) {
        const modal = new bootstrap.Modal(document.getElementById('confirmAnnulationModal'));
        document.getElementById('commandeNumber').textContent = commandeNumber;
        document.getElementById('deleteForm').action = `{{ path('commande_delete', {'id': '__ID__'}) }}`.replace('__ID__', commandeId);
        modal.show();
    }
</script>
{% endblock %}